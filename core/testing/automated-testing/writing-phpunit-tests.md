<!--
# Writing PHP Tests
-->

# PHP テストの作成

<!--
## About the WordPress PHPUnit Test Suite
-->

## WordPress の PHPUnit テストスイートについて

<!--
The WordPress PHPUnit Test Suite contains thousands of **automated tests**. Automated tests are small bits of code that verify a specific piece of WP functionality. These tests are a powerful tool both for feature development and for the prevention of regressions.
-->

WordPress の PHPUnit テストスイートには、何千もの**自動テスト**が含まれています。自動テストは、WP の機能の特定の部分を検証する小さなコードです。これらのテストは、機能開発やリグレッションを防止するための強力なツールです。

<!--
Automated tests should be as small and as specific as possible. Ideally, an automated test will be a **unit test**: a test that verifies a piece of functionality in complete isolation, without any dependency on the overall state of the system. In practice, the structure of WordPress and its test suite makes it difficult or impossible to write “pure” unit tests. Here and elsewhere, we use the term “unit test” to refer loosely to any automated test in the suite.
-->

自動テストは、できるだけ小さく、具体的なものにする必要があります。理想的には、自動テストは**ユニットテスト**であるべきです。システム全体の状態に依存することなく、機能の一部を完全に分離して検証するテストです。実際には、WordPress とそのテストスイートの構造上、「純粋な」ユニットテストを書くことは難しいか、不可能です。ここでも他の場所でも、スイート内の自動テストを大まかに指すために「ユニットテスト」という用語を使用します。

<!--
## The Basic Structure of a Test
-->

## テストの基本構造

<!--
### Assertions
-->

### アサーション

<!--
The most important part of any test is the **assertion**. An assertion is a comparison between the value you *expect* to get from the system, and the value that you *actually* get. The very simplest tests may consist of nothing but a single assertion. Example:
-->

あらゆるテストで最も重要なものは**アサーション**です。アサーションとは、システムから得られる**期待**値と、**実際に**得られた値との比較です。最も単純なテストは、単一のアサーションだけで構成されるかもしれません。例:

```php
public function test_trailingslashit_should_add_slash_when_none_is_present() {
	$this->assertSame( 'foo/', trailingslashit( 'foo' ) );
}
```

<!--
The `assertSame()` method accepts two parameters: the *expected value* (in this case, the hardcoded string `'foo/'`), and the *actual value* (the value returned by `trailingslashit()`).
-->

`assertSame()` メソッドは、**期待値** (この場合、ハードコードされた文字列 `'foo/'`) と **実際の値** (`trailingslashit()` によって返される値) の2つのパラメータを受け入れます。

<!--
An [annotated list of common assertions](#using-assertions) can be found below.
-->

[一般的なアサーションのアノテーション付きリスト](https://ja.wordpress.org/team/handbook/core/testing/automated-testing/writing-phpunit-tests/#using-assertions)は以下にあります。

<!--
### Fixtures and Factories
-->

### フィクスチャとファクトリ

<!--
Many tests require the existence of one or more data objects, like posts or users, that WordPress normally stores in the database. Each individual test method begins with an empty WordPress installation, so each test is responsible for creating its own objects for testing. These objects are called **fixtures**, and they are generated by **factories**.
-->

多くのテストでは、投稿やユーザーなど、WordPress が通常データベースに保存している1つ以上のデータオブジェクトの存在が必要です。個々のテストメソッドは空の WordPress インストールから始まるため、各テストはテスト用の独自のオブジェクトを作成する必要があります。これらのオブジェクトは**フィクスチャ**と呼ばれ、**ファクトリ**によって生成されます。

```php
public function test_user_with_editor_role_can_edit_others_posts() {
	$user_id = self::factory()->user->create( array(
		'role' => 'editor',
	) );

	$this->assertTrue( user_can( $user_id, 'edit_others_posts' ) );
}
```

<!--
The `create()` factory method returns the numeric ID of the object. To get the object instead, use `create_and_get()`:
-->

`create()` ファクトリメソッドはオブジェクトの数値 ID を返します。代わりにオブジェクトを取得するには、`create_and_get()` を使用します。

```php
public function test_user_exists() {
	$user = self::factory()->user->create_and_get();

	$this->assertTrue( $user->exists() );
}
```

<!--
Some tests require more than one object of a given kind. In this case, use `create_many()`, which uses an iterator to ensure object uniqueness (for example, unique email addresses in the case of users):
-->

テストによっては、同じ種類のオブジェクトを複数必要とするものがあります。この場合は `create_many()` を使用します。これはイテレータを使用してオブジェクトの一意性を保証します (たとえば、ユーザーの場合は一意のメールアドレス):

```php
public function test_term_query_count() {
	$tags = self::factory()->term->create_many( 3, array(
		'taxonomy' => 'post_tag',
	) );

	$term_query = new WP_Term_Query();
	$actual = $term_query->query( array(
		'taxonomy' => 'post_tag',
		'fields' => 'count',
	) );

	$this->assertSame( 3, $actual );
}
```

<!--
Factory `create*()` methods accept an array of arguments, specific to that object type. For more details, see the `__construct()` method of each factory class at https://core.trac.wordpress.org/browser/trunk/tests/phpunit/includes/factory.
-->

ファクトリの `create*()` メソッドは、そのオブジェクトタイプに固有の引数の配列を受け取ります。詳しくは、https://core.trac.wordpress.org/browser/trunk/tests/phpunit/includes/factory で各ファクトリクラスの `__construct()` メソッドを参照してください。

<!--
## Shared Fixtures
-->

## 共通のフィクスチャ

<!--
When all tests within a test class need the same fixtures to be available, it is common practice to abstract the creation of these fixtures out to a “set up” method. It is also good practice, to clean up after your test and remove any fixtures you have created.
-->

テストクラス内のすべてのテストが同じフィクスチャを利用できるようにする必要がある場合、これらのフィクスチャの作成を「set up」メソッドに抽象化することが一般的です。また、テスト後にクリーンアップし、作成したフィクスチャを削除することも良い習慣です。

<!--
[PHPUnit offers four methods](https://docs.phpunit.de/en/9.6/fixtures.html) which are automatically called to help with this: `setUpBeforeClass()`, `setUp()`, `tearDown()` and `tearDownAfterClass()`.
-->

[PHPUnit は4つのメソッドを提供](https://docs.phpunit.de/en/9.6/fixtures.html)しており、これらは自動的にコールされます: `setUpBeforeClass()`、`setUp()`、`tearDown()`、`tearDownAfterClass()` です。

<!--
In the context of the WordPress test suite, `snake_case` versions of these methods **MUST** be used. These *snake\_case* methods provide PHPUnit cross-version compatibility.
-->

WordPress のテストスイートでは、これらのメソッドの `snake_case` バージョンを**必ず**使わなければなりません。これらの *snake_case* メソッドは、PHPUnit のバージョン間の互換性を提供します。

<!--
| PHPUnit method name | WordPress method name |
| --- | --- |
| `setUpBeforeClass()` | `set_up_before_class()` |
| `setUp()` | `set_up()` |
| `assertPreConditions()` | `assert_pre_conditions()` |
| `assertPostConditions()` | `assert_post_conditions()` |
| `tearDown()` | `tear_down()` |
| `tearDownAfterClass()` | `tear_down_after_class()` |
-->

| PHPUnit のメソッド名 | WordPress のメソッド名 |
| --- | --- |
| `setUpBeforeClass()` | `set_up_before_class()` |
| `setUp()` | `set_up()` |
| `assertPreConditions()` | `assert_pre_conditions()` |
| `assertPostConditions()` | `assert_post_conditions()` |
| `tearDown()` | `tear_down()` |
| `tearDownAfterClass()` | `tear_down_after_class()` |

<!--
Functionality in a `set_up()` method will run before each test in a class, while anything in a `tear_down()` method will run immediately after each test in the class. In contrast, the `set_up_before_class()` method will run once before the class is instantiated and the `tear_down_after_class()` will run once after all tests in the class have been run.
-->

`set_up()` メソッド内の関数はクラスの各テストの前に実行され、`tear_down()` メソッド内の関数はクラスの各テストの直後に実行されます。対照的に、`set_up_before_class()` メソッドはクラスがインスタンス化される前に一度だけ実行され、`tear_down_after_class()` メソッドはクラス内のすべてのテストが実行された後に一度だけ実行されます。

<!--
By default, all test classes in the WordPress test suite extend from the `WP_UnitTestCase` class which inherits from the [`WP_UnitTestCase_Base`](https://core.trac.wordpress.org/browser/trunk/tests/phpunit/includes/abstract-testcase.php) class.
-->

デフォルトでは、WordPress のテストスイート内のすべてのテストクラスは `WP_UnitTestCase` クラスを継承しており、このクラスは [`WP_UnitTestCase_Base`](https://core.trac.wordpress.org/browser/trunk/tests/phpunit/includes/abstract-testcase.php) クラスを継承しています。

<!--
The `WP_UnitTestCase_Base` class already contains generic declarations of these fixture methods, which do things like: reset the database to its default state, clean up post types, taxonomies, some global variables, the registered hooks etc.
-->

`WP_UnitTestCase_Base` クラスには、これらのフィクスチャメソッドの一般的な宣言がすでに含まれており、データベースをデフォルトの状態にリセットしたり、投稿タイプやタクソノミー、いくつかのグローバル変数、登録済みのフックなどをクリーンアップしたりします。

<!--
When declaring a `set_up()` method in a test class, it is **critical** that the first line of the `set_up()` method is a call to `parent::set_up()`. Similarly, `tear_down()` methods should always call `parent::tear_down()` as the very last line.
-->

テストクラスで `set_up()` メソッドを宣言する場合、`set_up()` メソッドの最初の行が `parent::set_up()` の呼び出しであることが**重要**です。同様に、`tear_down()` メソッドは常に `parent::tear_down()` を最後の行として呼び出す必要があります。

```php
class Tests_Subset_functionName {
	public function set_up() {
		parent::set_up();
		// The specific set up for the tests within this class.
	}

	public function tear_down() {
		// Clean up specific to the tests within this class.
		parent::tear_down();
	}
}
```

<!--
For more information about when to use which method, please read through the [Fixtures chapter in the PHPUnit manual](https://docs.phpunit.de/en/9.6/fixtures.html).
-->

どのメソッドをいつ使用するかについての詳細は、[PHPUnit マニュアルのフィクスチャの章](https://docs.phpunit.de/en/9.6/fixtures.html)を参照してください。

<!--
## Using Assertions
-->

## アサーションの使用

<!--
The most basic assertion available in PHPUnit is `assertSame()`, which performs a strict equality check `===` between the `$expected` and `$actual` parameters. Nearly any test can be written using this assertion.
-->

PHPUnit で使用できるもっとも基本的なアサーションは `assertSame()` で、これは `$expected` パラメータと `$actual` パラメータが `===` であるかどうかを厳密にチェックします。ほぼすべてのテストは、このアサーションを使用して作成できます。

<!--
For convenience, PHPUnit makes many more assertion methods available. It is strongly recommended to use the most specific assertion available. See [the official documentation](https://docs.phpunit.de/en/9.6/assertions.html) for information. As of WP 5.9, all assertions as available in PHPUnit 9.x can be used in the WordPress test suite and will work PHPUnit cross-version.
-->

便利なことに、PHPUnit ではさらに多くのアサーションメソッドを使用できます。利用可能な最も具体的なアサーションを使用することを強くおすすめします。[公式ドキュメント](https://docs.phpunit.de/en/9.6/assertions.html)を参照してください。WP 5.9以降では、PHPUnit 9.x で使用できるすべてのアサーションが WordPress のテストスイートで使用でき、PHPUnit のクロスバージョンで動作します。

<!--
Some of the more common assertion methods:
-->

よく使われるアサーションメソッドのいくつかを以下に示します:

<!--
*   `assertContains()` and `assertNotContains()`
*   `assertStringContainsString()` and `assertStringNotContainsString()`
*   `assertTrue()` and `assertFalse()`
*   `assertNull()`, `assertEmpty()`, `assertNotEmpty()`
-->

*   `assertContains()` と `assertNotContains()`
*   `assertStringContainsString()` と `assertStringNotContainsString()`
*   `assertTrue()` と `assertFalse()`
*   `assertNull()`、`assertEmpty()`、`assertNotEmpty()`

<!--
In addition to assertion methods offered by PHPUnit, WordPress has a number of custom assertions method available:
-->

PHPUnit が提供するアサーションメソッドに加えて、WordPress には独自のアサーションメソッドが多数用意されています:

<!--
*   `assertEqualSets( $expected, $actual, $message = '' )` – Asserts the equivalence of two arrays, ignoring order and strict equality (eg `assertEqualSets( [ 1, 2 ], [ '2', '1' ] )`)
*   `assertEqualSetsWithIndex( $expected, $actual, $message = '' )`
*   `assertSameSets( $expected, $actual, $message = '' )`
*   `assertSameSetsWithIndex( $expected, $actual, $message = '' )`
*   `assertWPError( $actual, $message = '' )` and `assertNotWPError( $actual, $message = '' )`
*   `assertIXRError( $actual, $message = '' )` and `assertNotIXRError( $actual, $message = '' )`
*   `assertEqualFields( $object, $fields, $message = '' )`
*   `assertDiscardWhitespace( $expected, $actual, $message = '' )`
*   `assertSameIgnoreEOL( $expected, $actual, $message = '' )`
*   `assertNonEmptyMultidimensionalArray( $array, $message = '' )`
-->

*   `assertEqualSets( $expected, $actual, $message = '' )` – 順序や厳密な等式を無視して、2つの配列の等価性を保証する (例 `assertEqualSets( [ 1, 2 ], [ '2', '1' ] )`)
*   `assertEqualSetsWithIndex( $expected, $actual, $message = '' )`
*   `assertSameSets( $expected, $actual, $message = '' )`
*   `assertSameSetsWithIndex( $expected, $actual, $message = '' )`
*   `assertWPError( $actual, $message = '' )` と `assertNotWPError( $actual, $message = '' )`
*   `assertIXRError( $actual, $message = '' )` と `assertNotIXRError( $actual, $message = '' )`
*   `assertEqualFields( $object, $fields, $message = '' )`
*   `assertDiscardWhitespace( $expected, $actual, $message = '' )`
*   `assertSameIgnoreEOL( $expected, $actual, $message = '' )`
*   `assertNonEmptyMultidimensionalArray( $array, $message = '' )`

<!--
See a complete list in the [`WP_UnitTestCase_Base`](https://core.trac.wordpress.org/browser/trunk/tests/phpunit/includes/abstract-testcase.php) class.
-->

完全なリストは、[`WP_UnitTestCase_Base`](https://core.trac.wordpress.org/browser/trunk/tests/phpunit/includes/abstract-testcase.php) クラスを参照してください。

<!--
All PHPUnit assertions, as well as all WordPress custom assertions, allow for a `$message` parameter to be passed. This message will be displayed when the assertion fails and can help immensely when debugging a test. This parameter should always be used if more than one assertion is used in a test method.
-->

PHPUnit のすべてのアサーションと WordPress のすべてのカスタムアサーションでは、`$message` パラメータを渡すことができます。このメッセージはアサーションが失敗したときに表示され、テストのデバッグにとても役立ちます。テストメソッド内で複数のアサーションを使用する場合は、このパラメータを必ず使用する必要があります。

```php
class Tests_Foo {
	public function test_function_call() {
		$actual = function_call();

		$this->assertIsArray( $actual, 'Return value of function_call() is not an array' );
		$this->assertArrayHasKey( 'desired_key', $actual, 'Key "desired_key" does not exist in array returned by function_call()' );
		$this->assertSame( 'expected_value', $actual['desired_key'], 'Value for array key "desired_key" does not match expectations' );
	}
}
```

<!--
## Annotations
-->

## アノテーション

<!--
[PHPUnit annotations](https://docs.phpunit.de/en/9.6/annotations.html) are pieces of metadata, indicated by a `@`, placed in the docblock of a test method or class. WordPress’s tests use a number of PHPUnit annotations, as well as a few custom ones, to organize its tests. Note that annotations belonging to a class are automatically inherited by all member test methods, and should not be appended with a full stop.
-->

[PHPUnit アノテーション](https://docs.phpunit.de/en/9.6/annotations.html)とは、メソッドやクラスの docblock に記述するメタデータのことで、`@` で示されます。WordPress のテストでは、テストを整理するために、多数の PHPUnit アノテーションといくつかのカスタムアノテーションが使用されます。クラスに属するアノテーションはすべてのメンバーのテストメソッドによって自動的に継承されるため、ピリオドを追加しないでください。

<!--
Some of the more commonly used annotations:
-->

よく使われるアノテーションのいくつかを以下に示します:

<!--
*   `@group` – Used to sort tests and test classes by functionality, into groups that can be run separately (eg `$ phpunit --group comment`). All test classes should have at least one `@group` annotation, and individual tests should have additional `@group` annotations as necessary.
*   `@covers` – Used to annotate which function, method or class is actually being tested by a particular test. It is **strongly recommended** to add a `@covers` tag for every test.
*   `@requires` – This annotation is used to indicate that a test has a dependency on, for instance, a specific PHP (minimum) version, a PHP extension or a particular function being available. If a test can only succeed if such a dependency exists and is fulfilled, the `@requires` tag should be added to the test docblock. The [PHPUnit manual](https://docs.phpunit.de/en/9.6/incomplete-and-skipped-tests.html#incomplete-and-skipped-tests-requires-tables-api) has some great examples of how to use this tag.
*   `@ticket` – A custom WordPress annotation. Use `@ticket 12345` to indicate that a test addresses the bug described in ticket [#12345](https://core.trac.wordpress.org/ticket/12345). Internally, `@ticket` annotations are translated to `@group`, so that you can limit test runs to those associated with a specific ticket: `$ phpunit --group 12345`.
*   `@expectedDeprecated` – Custom to WordPress. Indicates that a `_deprecated_*()` notice is expected to be thrown by the specified function/method/class. Without this annotation, tests that trigger a deprecation notice will fail; similarly, if you include this annotatation but the test does not trigger a deprecation notice, the test will fail. For example, tests for the deprecated `like_escape()` contain the annotation `@expectedDeprecated like_escape`.
*   `@expectedIncorrectUsage` – Similar to `@expectedDeprecated`, but for `_doing_it_wrong()` notices.
-->

*   `@group` - テストやテストクラスを機能ごとに分類してグループ化し、個別に実行できるようにします (例: `$ phpunit --group comment`)。すべてのテストクラスは少なくともひとつの `@group` アノテーションを持つべきで、個々のテストは必要に応じてさらに `@group` アノテーションを持つべきです。
*   `@covers` - 特定のテストで実際にテストされる関数、メソッド、またはクラスにアノテーションを付けるために使用されます。すべてのテストに `@covers` タグを追加することを**強くおすすめします**。
*   `@requires` - このアノテーションは、テストが特定の PHP (最小) バージョン、PHP 拡張、または特定の関数に依存していることを示すために使用します。そのような依存関係が存在し、それが満たされている場合にのみテストが成功する場合は、`@requires` タグをテストの docblock に追加する必要があります。[PHPUnit マニュアル](https://docs.phpunit.de/en/9.6/incomplete-and-skipped-tests.html#incomplete-and-skipped-tests-requires-tables-api)に、このタグに関する優れた例がいくつかあります。
*   `@ticket` - WordPress のカスタムアノテーション。チケット [#12345](https://core.trac.wordpress.org/ticket/12345) で説明されているバグに対応したテストであることを示すには、`@ticket 12345` を使用します。内部的には、`@ticket` アノテーションは `@group` に変換されるため、テストの実行を特定のチケットに関連するものに限定できます: `phpunit --group 12345`。
*   `@expectedDeprecated` - WordPress 独自のものです。指定した関数/メソッド/クラスが `_deprecated_*()` 通知をスローすることが期待されていることを示します。このアノテーションがないと、非推奨通知が発生するテストは失敗します。同様に、このアノテーションを含めてもテストで非推奨通知が発生しない場合は、テストは失敗します。たとえば、非推奨の `like_escape()` に対するテストには `@expectedDeprecated like_escape` というアノテーションが含まれています。
*   `@expectedIncorrectUsage` - `@expectedDeprecated` と似ていますが、`_doing_it_wrong()` の通知のためのものです。

<!--
## Naming and Organization
-->

## 名前と構成

<!--
The WordPress team strives to make tests easy to find, easy to maintain, and easy to run in isolation. As such, we have a number of guidelines for organizing and naming tests.
-->

WordPress チームは、テストを見つけやすく、保守しやすく、単体で実行しやすくするよう努めています。そのため、テストを整理したり名前をつけたりするためのいくつかのガイドラインを用意しています。

<!--
All PHPUnit tests are located in the `/tests/phpunit/tests/` directory. Paths given below are relative to this root.
-->

すべての PHPUnit テストは `/tests/phpunit/tests/` ディレクトリにあります。以下に示すパスは、このルートからの相対パスとなります。

<!--
### Test Classes
-->

### テストクラス

<!--
Tests are organized into classes. Group tests into a class when they test different aspects of the same piece of functionality. It’s especially convenient to put tests together in a class when they can share a common `set_up()` or `set_up_before_class()` routine. As a rule, a single test class should not contain tests for more than one function/method.
-->

テストはクラスにまとまっています。同じ機能の異なる部分をテストする場合は、テストを一つのクラスにまとめます。特に、共通の `set_up()` や `set_up_before_class()` ルーチンを使用する場合は、テストをひとつのクラスにまとめると便利です。原則として、ひとつのテストクラスに複数の関数やメソッドのテストを含めるべきではありません。

<!--
Each test class should be in its own file. Test files are sorted into folder based on shared functionality, which generally matches the primary `@group` annotation for those tests. Test files should be named using camelCase.
-->

各テストクラスは、それ自身がファイルでなければなりません。テストファイルは共有された機能にもとづいてフォルダーに分類されます。共有機能は通常、それらのテストのプライマリ `@group` アノテーションと一致します。テストファイルにはキャメルケースを使用して名前を付ける必要があります。

<!--
Test class names should reflect the filepath, with underscores replacing directory separators and TitleCase replacing camelCase. Thus, the class `Tests_Comment_GetCommentClass()`, which contains tests for the `get_comment_class()` function, is located in `tests/comment/getCommentClass.php`.
-->

テストクラス名はファイルパスを反映したものにし、アンダースコアをディレクトリの区切り文字に、タイトルケースをキャメルケースに置き換えてください。したがって、`get_comment_class()` 関数のテストを含む `Tests_Comment_GetCommentClass()` クラスは `tests/comment/getCommentClass.php` にあります。

<!--
### Test Methods
-->

### テストメソッド

<!--
Method names in a test class must begin with `test_`. Methods that do not begin with `test_` will not be run by PHPUnit; filter callbacks or other utility methods should not have this prefix. Test method names should be written in snake\_case.
-->

テストクラスのメソッド名は、必ず `test_` で始めなければなりません。`test_` で始まらないメソッドは、PHPUnit によって実行されません。フィルターコールバックまたは他のユーティリティメソッドには、この接頭辞を付けることはできません。テストメソッド名はスネークケースで記述する必要があります。

<!--
The test name should be as descriptive as possible. For example, `Tests_Comment_GetCommentClass::test_should_accept_comment_id()` tests whether `get_comment_class()` accepts a comment ID. Test names that describe the desired outcome of the test, ideally containing the word ‘should’, make debugging far easier; a good test name might make it unnecessary to look at the test source when a failure is spotted during a test run.
-->

テスト名は、できるだけわかりやすいものにしてください。たとえば `Tests_Comment_GetCommentClass::test_should_accept_comment_id()` は、`get_comment_class()` がコメント ID を受け入れるかどうかをテストします。テストの望ましい結果を表すテスト名 (理想的には「should」という単語を含む) は、デバッグがはるかに簡単になります。適切なテスト名であれば、テストの実行中に失敗が見つかったときにテストのソースを見る必要がなくなるかもしれません。

<!--
## Advanced Topics
-->

## 高度なトピック

<!--
### Slow Fixtures
-->

### 遅いフィクスチャ

<!--
Sometimes, all tests in a class can use the same database fixtures. Generating these fixtures inside of `set_up()` will cause them to be recreated for each test, which can dramatically decrease test performance. In these cases, it’s possible to create fixtures once, before any tests in the class have run, using `wpSetUpBeforeClass()`:
-->

場合によっては、クラス内のすべてのテストで同じデータベースフィクスチャを使うことがあります。これらのフィクスチャを `set_up()` の中で生成すると、テストごとにフィクスチャが再作成されることになり、テストのパフォーマンスが大幅に低下する可能性があります。このような場合は `wpSetUpBeforeClass()` を使用して、クラスのテストが実行される前にフィクスチャを一度だけ作成します:

```php
class Tests_Comment_Stuff {
	protected static $comment_post_id;

	public static function wpSetUpBeforeClass( $factory ) {
		self::$comment_post_id = $factory->post->create();
	}
}
```

<!--
Similarly, `wpTearDownAfterClass()` can be used for cleanup after all of a class’ tests have been run (though note that this is generally unnecessary, as the test suite tries to clean up all shared fixtures automatically).
-->

同様に、`wpTearDownAfterClass()` はクラスのテストがすべて実行された後のクリーンアップのために使用できます (ただし、テストスイートはすべての共有フィクスチャを自動的にクリーンアップしようとするので、一般的には不要であることに注意してください)。

<!--
Some notes about shared fixtures:
-->

共有フィクスチャに関するいくつかの注意点:

<!--
*   `wpSetUpBeforeClass()` and `wpTearDownAfterClass()` must be declared as static and called statically.
*   Because the methods are static, the way that the data is stored for use in the test methods must also be static: `self::$foo` rather than `$this->foo`.
*   Do not call `self::factory()` in `wpSetUpBeforeClass()`, as it will break the uniqueness iterator; always use the `$factory` object passed to the method.
-->

*   `wpSetUpBeforeClass()` と `wpTearDownAfterClass()` は static として宣言し、静的に呼び出す必要があります。
*   メソッドは静的であるため、テストメソッドで使用するためにデータを保存する方法も静的である必要があります。つまり、`$this->foo` ではなく `self::$foo` です。
*   イテレータの一意性が壊れてしまうため、`wpSetUpBeforeClass()` 内で `self::factory()` を呼び出さないでください。メソッドに渡される `$factory` オブジェクトを常に使用してください。

<!--
### Repetitive Tests
-->

### 反復テスト

<!--
Whenever you have the inclination to copy and paste the code of a test method to test the same WordPress functionality with only slightly different arguments, please consider using a data provider instead.
-->

テストメソッドのコードをコピー & ペーストして、同じ WordPress の機能を少し異なる引数でテストしたくなったときは、代わりにデータプロバイダの使用を検討してください。

<!--
A [data provider](https://docs.phpunit.de/en/9.6/writing-tests-for-phpunit.html#data-providers) is a secondary function which is linked to a test using a `@dataProvider` annotation in the docblock of the test method and is generally named after the test, replacing the `test` prefix in the method name with `data`.
-->

[データプロバイダ](https://phpunit.readthedocs.io/en/9.5/writing-tests-for-phpunit.html#data-providers)は、テストメソッドの docblock にある `@dataProvider` アノテーションを使ってテストにリンクされる二次関数のことで、一般的にはメソッド名の `test` 接頭辞を `data` に置き換えてテスト名にします。

<!--
This second function must return an array of arrays, where each entry in this array is called a *data set* and passed to the test function as input parameters.
-->

この2番目の関数は、二次元配列を返す必要があります。この配列内の各エントリーは「データセット」と呼ばれ、入力パラメータとしてテスト関数に渡されます。

<!--
It is highly recommended to use [named data sets](https://docs.phpunit.de/en/9.6/writing-tests-for-phpunit.html#writing-tests-for-phpunit-data-providers-examples-datatest1-php) in a data provider.
-->

データプロバイダでは、[名前付きデータセット](https://docs.phpunit.de/en/9.6/writing-tests-for-phpunit.html#writing-tests-for-phpunit-data-providers-examples-datatest1-php)を使用することを強くおすすめします。

<!--
### One-off Functions for Hooks
-->

### フックのための一度限りの関数

<!--
If your test needs a one-off callback function to hook into an action/filter, please feel free to use a [closure](https://www.php.net/functions.anonymous) (anonymous function).
-->

アクションやフィルターにフックするための一度限りのコールバック関数が必要な場合は、[クロージャ](https://www.php.net/functions.anonymous) (無名関数) を自由に使ってください。

<!--
And if your closure does not use the `$this` variable, please declare the closure as `static` for optimal performance.
-->

また、クロージャが `$this` 変数を使用しない場合は、最適なパフォーマンスを得るためにクロージャを `static` として宣言してください。

<!--
Using closures as hook callbacks *in Core/plugins/themes* is **not** recommended, as anonymous functions do not allow for unhooking the callback from the hook. However, this is not a problem in the test suite, as the whole stack of registered actions and filters will be reset after each test via the shared `tear_down()` method.
-->

**コア、プラグイン、テーマ**のフックのコールバックとしてクロージャを使用することは**推奨されません**。無名関数では、フックからコールバックを外すことができないからです。しかし、これはテストスイートでは問題ありません。登録されたアクションとフィルターのスタック全体は、共有された `tear_down()` メソッドによってテストのたびにリセットされるからです。

<!--
## Technical Overview
-->

## 技術概要

<!--
For the curious, here’s a quick overview of how PHPUnit is leveraged to work with an application like WordPress.
-->

興味のある方のために、WordPress のようなアプリケーションで PHPUnit がどのように使われるのかを簡単に説明します。

<!--
### The WordPress Installation and Bootstrap
-->

### WordPress インストールと ブートストラップ

<!--
When `phpunit` is invoked, the test suite runs a script that sets up a default installation of WordPress, with a configuration similar to what you get with the GUI install. Before any tests are run, the following steps take place:
-->

`phpunit` が起動されると、GUI インストールと同様の構成で、テストスイートは WordPress のデフォルトインストールを設定するスクリプトを実行します。テストが実行される前に、次の手順が行われます:

<!--
*   WordPress is bootstrapped (by including `wp-settings.php`). This means that all tests run *after* the entire WP bootstrap (through `wp_loaded`).
*   All default content is deleted. This includes sample posts and pages, but does *not* include the default user or the ‘Uncategorized’ category.
-->

*   (`wp-settings.php` をインクルードすることで) WordPress を起動します。これは、すべてのテストが (`wp_loaded` にを通じて) WP ブートストラップ全体の**後に**実行されることを意味します。
*   デフォルトのコンテンツはすべて削除されます。これにはサンプルの投稿とページが含まれますが、デフォルトのユーザーや「未分類」カテゴリーは**含まれません**。

<!--
### Globals
-->

### グローバル

<!--
The WP globals that reflect current page state, such as `$wp` and `$wp_query`, are reset to a default state after each test is run. Similarly, post-related globals like `$post` and `$more` are set to `null` after each test. The test suite also resets runtime-registered object types to their defaults; this means that custom post types, taxonomies, etc must be reregistered for every test. Last but not least, all actions and filters are reset to their original state after each test as well, so it is not necessary to manually remove hooks that have been added in a test.
-->

`$wp` や `$wp_query` など、現在のページの状態を反映する WP グローバルは、テストを実行するたびにデフォルトの状態にリセットされます。同様に、`$post` や `$more` などの投稿関連のグローバルも、テストが実行されるたびに `null` に設定されます。テストスイートは、ランタイムに登録されたオブジェクトタイプもデフォルトにリセットします。これは、カスタム投稿タイプやタクソノミーなどをテストごとに再登録する必要があることを意味します。最後に重要なことですが、すべてのアクションとフィルターも各テストの後に元の状態にリセットされるので、テストで追加されたフックを手動で削除する必要はありません。

<!--
Modifications to other globals should be managed carefully by the tests themselves. A simple convention to do so is to store the original global in a local variable and reset it back to that value after the test logic has been run. It is important that such resets should happen before the actual assertion is made, so that subsequent test results are not polluted by one possible failure.
-->

他のグローバルへの変更は、テスト自体で慎重に管理する必要があります。そのための簡単な規約は、元のグローバルをローカル変数に格納し、テストロジックの実行後にその値にリセットすることです。このようなリセットは、実際のアサーションが行われる前に行うことが重要です、そうすることで、一つの失敗によってその後のテスト結果が汚染されることがなくなります。

<!--
### Database
-->

### データベース

<!--
WordPress keeps both data (posts, users) and state (options) in the database. And the structure of WordPress is such that it’s almost impossible to mock fixtures and settings without actually using a database. As such, the test suite *does* use a MySQL database for setting up the WP application and for storing fixtures and other data.
-->

WordPress は、データ (投稿、ユーザー) と状態 (オプション) の両方をデータベースに保持します。そして WordPress の構造は、実際にデータベースを使わずにフィクスチャや設定をモックすることはほとんど不可能です。そのため、テストスイートは WP アプリケーションのセットアップとフィクスチャやその他のデータの保存に MySQL データベースを**使用します**。

<!--
It’s important to distinguish between persistent and non-persistent database content in the test suite. When `phpunit` is invoked, the test suite wipes the test database clean and performs a clean installation. This data – such as the default content of `wp_options` – is persistent through the tests.
-->

テストスイートでは、永続的なデータベースと永続的でないデータベースのコンテンツを区別することが重要です。`phpunit` が起動されると、テストスイートはテストデータベースを消去してクリーンインストールを行います。このデータ (`wp_options` のデフォルトの内容など) は、テスト中も持続します。

<!--
Database modifications made during test, on the other hand, are *not* persistent. Before each test, the suite opens a MySQL transaction (`START TRANSACTION`) with `autocommit` disabled, and at the end of each test the transaction is rolled back (`ROLLBACK`). This means that database operations performed from within a test, such as the creation of test fixtures, are discarded after each test. For more information on transactions, see [the official MySQL documentation](https://dev.mysql.com/doc/refman/5.7/en/commit.html), and especially the section on [statements that trigger commits](https://dev.mysql.com/doc/refman/5.7/en/implicit-commit.html).
-->

一方、テスト中に行われたデータベースの変更は永続的**ではありません**。各テストの前に、スイートは `autocommit` を無効にして MySQL のトランザクション (`START TRANSACTION`) を開き、各テストの終了時にトランザクションをロールバック (`ROLLBACK`) します。つまり、テストフィクスチャの作成など、テスト内から実行されたデータベース操作は各テストが終了した後に破棄されます。トランザクションの詳細については、[MySQL 公式ドキュメント](https://dev.mysql.com/doc/refman/5.7/en/commit.html)を参照し、特に[コミットをトリガーするステートメント](https://dev.mysql.com/doc/refman/5.7/en/implicit-commit.html)のセクションを参照してください。
